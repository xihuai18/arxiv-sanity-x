"use strict";(()=>{var $=Object.defineProperty,q=Object.defineProperties;var Q=Object.getOwnPropertyDescriptors;var A=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var _=(a,e,n)=>e in a?$(a,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[e]=n,M=(a,e)=>{for(var n in e||(e={}))X.call(e,n)&&_(a,n,e[n]);if(A)for(var n of A(e))Y.call(e,n)&&_(a,n,e[n]);return a},S=(a,e)=>q(a,Q(e));var c=window.ArxivSanityCommon,m=c.csrfFetch,Z=c.setupUserEventStream,ee=c.registerEventHandler,ae=c.renderTldrMarkdown,F=c.formatAuthorsText,te=c.triggerMathJax,I=c.buildTagUrl,ne=c.buildKeywordUrl,ie=c.registerDropdown,se=c.unregisterDropdown;function R(a){!a||!a.success||(a.tags&&T(a.tags,{renderCombined:!1}),a.combined_tags&&f(a.combined_tags),a.keys&&k(a.keys))}function de(){return c.fetchUserState().then(R)}function oe(a,e,n){if(!a||!Array.isArray(papers))return;const t=papers.find(i=>i&&i.id===a);t&&(t.summary_status=e||"",t.summary_last_error=n||"",u())}function le(a,e){if(!a||!e||!Array.isArray(papers))return;let n=!1;papers.forEach(t=>{if(t){if(Array.isArray(t.utags)){const i=t.utags.map(s=>s===a?e:s);i.join("|")!==t.utags.join("|")&&(t.utags=i,n=!0)}if(Array.isArray(t.ntags)){const i=t.ntags.map(s=>s===a?e:s);i.join("|")!==t.ntags.join("|")&&(t.ntags=i,n=!0)}}}),n&&u()}function re(a){if(!a||!Array.isArray(papers))return;let e=!1;papers.forEach(n=>{if(n){if(Array.isArray(n.utags)){const t=n.utags.filter(i=>i!==a);t.length!==n.utags.length&&(n.utags=t,e=!0)}if(Array.isArray(n.ntags)){const t=n.ntags.filter(i=>i!==a);t.length!==n.ntags.length&&(n.ntags=t,e=!0)}}}),e&&u()}function ge(a,e,n){if(!a||!e||!Array.isArray(papers))return;const t=papers.find(d=>d&&d.id===a);if(!t)return;const i=new Set(t.utags||[]),s=new Set(t.ntags||[]);n===1?(i.add(e),s.delete(e)):n===-1?(i.delete(e),s.add(e)):(i.delete(e),s.delete(e)),t.utags=Array.from(i),t.ntags=Array.from(s),u()}function he(a){!a||!a.pid||(a.action==="add"?(U(a.pid),u()):a.action==="remove"&&(j(a.pid),u()))}function me(a,e={}){!a||typeof a!="object"||(a.type==="user_state_changed"?(a.reason==="rename_tag"?le(a.from,a.to):a.reason==="delete_tag"?re(a.tag):a.reason==="tag_feedback"&&a.pid&&a.tag&&a.label!==void 0&&ge(a.pid,a.tag,a.label),de()):a.type==="summary_status"?oe(a.pid,a.status,a.error):a.type==="readinglist_changed"&&he(a))}function ce(){ee(me),Z(user,R)}function ue(a){return a?a==="queued"?"Summary Queued":a==="running"?"Summary Generating":a==="ok"?"Summary Ready":a==="failed"?"Summary Failed":"Summary "+a.charAt(0).toUpperCase()+a.slice(1):""}function V(a){return!(a==="ok"||a==="running"||a==="queued")}const O=typeof window!="undefined"&&window.ArxivSanityTagDropdown&&window.ArxivSanityTagDropdown.MultiSelectDropdown?window.ArxivSanityTagDropdown.MultiSelectDropdown:a=>React.createElement("div",null,"Tag dropdown unavailable"),be=a=>{const e=a.paper,t=a.tags.map(v=>v.name),i=e.utags,s="/?rank=pid&pid="+encodeURIComponent(e.id),d="/inspect?pid="+encodeURIComponent(e.id),o="/summary?pid="+encodeURIComponent(e.id),g=e.thumb_url===""?null:React.createElement("div",{class:"rel_img"},React.createElement("img",{src:e.thumb_url}));let l=null;user&&(l=React.createElement("div",{class:"rel_utags"},React.createElement(O,{selectedTags:i,negativeTags:a.negativeTags,availableTags:t,isOpen:a.dropdownOpen,onToggle:a.onToggleDropdown,onTagCycle:a.onTagCycle,onClearTag:a.onClearTag,newTagValue:a.newTagValue,onNewTagChange:a.onNewTagChange,onAddNewTag:a.onAddNewTag,dropdownId:a.dropdownId,searchValue:a.searchValue,onSearchChange:a.onSearchChange})));const r=e.tldr?React.createElement("div",{class:"rel_tldr"},React.createElement("div",{class:"tldr_label"},"\u{1F4A1} TL;DR"),React.createElement("div",{class:"tldr_text",dangerouslySetInnerHTML:{__html:ae(e.tldr)}})):null,h=ue(a.summaryStatus),p=a.summaryStatus==="ok"?"summary-status-badge ok":a.summaryStatus==="failed"?"summary-status-badge failed":a.summaryStatus?"summary-status-badge":"",y=h?React.createElement("div",{class:p,title:a.summaryLastError||""},h):null;let b=null;if(user){const v=a.inReadingList,W=v?"readinglist-btn active":"readinglist-btn",J=v?"In reading list":"Add to reading list",G=v?"\u{1F4D6}":"\u{1F516}";b=React.createElement("div",{class:W,onClick:a.onToggleReadingList,title:J},G)}const w=!V(a.summaryStatus),H=React.createElement("button",{class:"summary-trigger-btn",onClick:a.onTriggerSummary,disabled:w,title:w?"Summary already available or generating":"Generate summary"},"\u2728 Generate Summary");return React.createElement("div",{class:"rel_paper"},React.createElement("div",{class:"rel_score"},e.weight.toFixed(2),e.score_breakdown&&React.createElement("div",{class:"score_breakdown"},e.score_breakdown)),b,React.createElement("div",{class:"rel_title"},React.createElement("a",{href:"http://arxiv.org/abs/"+e.id,target:"_blank",rel:"noopener noreferrer"},e.title)),React.createElement("div",{class:"rel_authors",title:e.authors||""},F(e.authors,{maxAuthors:10,head:5,tail:3})),React.createElement("div",{class:"rel_time"},e.time),React.createElement("div",{class:"rel_tags"},e.tags),y,r,g,React.createElement("div",{class:"rel_abs"},e.summary),l,React.createElement("div",{class:"paper-actions-footer"},React.createElement("div",{class:"rel_summary"},H),React.createElement("div",{class:"rel_more"},React.createElement("a",{href:s,target:"_blank",rel:"noopener noreferrer"},"Similar")),React.createElement("div",{class:"rel_inspect"},React.createElement("a",{href:d,target:"_blank",rel:"noopener noreferrer"},"Inspect")),React.createElement("div",{class:"rel_summary"},React.createElement("a",{href:o,target:"_blank",rel:"noopener noreferrer"},"Summary")),React.createElement("div",{class:"rel_alphaxiv"},React.createElement("a",{href:"https://www.alphaxiv.org/overview/"+e.id,target:"_blank",rel:"noopener noreferrer"},"alphaXiv")),React.createElement("div",{class:"rel_cool"},React.createElement("a",{href:"https://papers.cool/arxiv/"+e.id,target:"_blank",rel:"noopener noreferrer"},"Cool"))))},fe=a=>{const e=a.papers,n=a.tags.filter(i=>i.name!=="all"),t=e.map((i,s)=>React.createElement(Ce,{key:s,paper:i,tags:n}));return React.createElement("div",null,React.createElement("div",{id:"paperList",class:"rel_papers"},t))};class Ce extends React.Component{constructor(e){super(e),Array.isArray(e.paper.utags)||(e.paper.utags=[]),Array.isArray(e.paper.ntags)||(e.paper.ntags=[]),this.state={paper:e.paper,tags:e.tags,dropdownOpen:!1,newTagValue:"",searchValue:"",inReadingList:Ke(e.paper.id),summaryStatus:e.paper.summary_status||"",summaryLastError:e.paper.summary_last_error||""},this.dropdownId="dropdown-"+e.paper.id,this.handleToggleDropdown=this.handleToggleDropdown.bind(this),this.handleTagCycle=this.handleTagCycle.bind(this),this.handleClearTag=this.handleClearTag.bind(this),this.handleNewTagChange=this.handleNewTagChange.bind(this),this.handleAddNewTag=this.handleAddNewTag.bind(this),this.handleSearchChange=this.handleSearchChange.bind(this),this.handleToggleReadingList=this.handleToggleReadingList.bind(this),this.handleTriggerSummary=this.handleTriggerSummary.bind(this)}componentDidMount(){ie(this.dropdownId,{isOpen:()=>this.state.dropdownOpen,close:()=>{const e=document.getElementById(this.dropdownId);if(e){const n=e.closest(".rel_paper");n&&n.classList.remove("dropdown-open")}this.setState({dropdownOpen:!1})}}),this.state.paper.tldr&&te(document.getElementById("paperList"))}componentDidUpdate(e){e.tags!==this.props.tags&&this.setState({tags:this.props.tags})}componentWillUnmount(){se(this.dropdownId)}handleToggleDropdown(){this.setState(e=>{const n=!e.dropdownOpen,t=document.getElementById(this.dropdownId);if(t){const i=t.closest(".rel_paper");i&&(n?i.classList.add("dropdown-open"):i.classList.remove("dropdown-open"))}return{dropdownOpen:n,searchValue:n?"":e.searchValue}})}handleSearchChange(e){this.setState({searchValue:e.target.value})}applyTagFeedback(e,n){const{paper:t}=this.state;return m("/api/tag_feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:t.id,tag:e,label:n})}).then(i=>i.json()).then(i=>{if(!i||!i.success){const h=i&&i.error?i.error:"Unknown error";throw new Error(h)}const s=new Set(t.utags||[]),d=new Set(t.ntags||[]),o=s.has(e),g=d.has(e);let l=0,r=0;return n===1?(o||(s.add(e),l+=1),g&&(d.delete(e),r-=1)):n===-1?(o&&(s.delete(e),l-=1),g||(d.add(e),r+=1)):(o&&(s.delete(e),l-=1),g&&(d.delete(e),r-=1)),(l||r)&&_e(e,l,r),t.utags=Array.from(s),t.ntags=Array.from(d),this.setState({paper:t}),!0})}handleTagCycle(e){const{paper:n}=this.state,t=(n.utags||[]).includes(e),i=(n.ntags||[]).includes(e),s=t?-1:i?0:1;this.applyTagFeedback(e,s).catch(d=>{console.error("Error updating tag feedback:",d),alert("Failed to update tag feedback: "+d.message)})}handleClearTag(e){this.applyTagFeedback(e,0).catch(n=>{console.error("Error clearing tag feedback:",n),alert("Failed to clear tag feedback: "+n.message)})}handleNewTagChange(e){this.setState({newTagValue:e.target.value})}handleAddNewTag(){const{paper:e,newTagValue:n}=this.state,t=n.trim();if(t){if(e.utags.includes(t)){alert("Tag already exists");return}this.applyTagFeedback(t,1).then(()=>{this.setState({paper:e,newTagValue:""}),console.log(`Added new tag: ${t}`)}).catch(i=>{console.error("Error adding new tag:",i),alert("Failed to add new tag: "+i.message)})}}handleToggleReadingList(){const{paper:e,inReadingList:n}=this.state;n?m("/api/readinglist/remove",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:e.id})}).then(t=>t.json()).then(t=>{t.success?(j(e.id),this.setState({inReadingList:!1}),console.log(`Removed ${e.id} from reading list`)):console.error("Failed to remove from reading list:",t.error)}).catch(t=>{console.error("Error removing from reading list:",t)}):m("/api/readinglist/add",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:e.id})}).then(t=>t.json()).then(t=>{t.success?(U(e.id),this.setState({inReadingList:!0,summaryStatus:"queued",summaryLastError:""}),console.log(`Added ${e.id} to reading list, top_tags:`,t.top_tags)):(console.error("Failed to add to reading list:",t.error),alert("Failed to add to reading list: "+t.error))}).catch(t=>{console.error("Error adding to reading list:",t),alert("Network error, failed to add to reading list")})}handleTriggerSummary(){const{paper:e,summaryStatus:n}=this.state;V(n)&&(this.setState({summaryStatus:"queued",summaryLastError:""}),m("/api/trigger_paper_summary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:e.id})}).then(t=>t.json()).then(t=>{t.success?this.setState({summaryStatus:t.status||"queued",summaryLastError:t.last_error||""}):(this.setState({summaryStatus:"failed",summaryLastError:t.error||""}),alert("Failed to trigger summary: "+(t.error||"Unknown error")))}).catch(t=>{console.error("Error triggering summary:",t),this.setState({summaryStatus:"failed",summaryLastError:String(t)}),alert("Network error, failed to trigger summary")}))}render(){return React.createElement(be,{paper:this.state.paper,tags:this.state.tags,negativeTags:this.state.paper.ntags||[],dropdownOpen:this.state.dropdownOpen,onToggleDropdown:this.handleToggleDropdown,onTagCycle:this.handleTagCycle,onClearTag:this.handleClearTag,newTagValue:this.state.newTagValue,onNewTagChange:this.handleNewTagChange,onAddNewTag:this.handleAddNewTag,dropdownId:this.dropdownId,searchValue:this.state.searchValue,onSearchChange:this.handleSearchChange,inReadingList:this.state.inReadingList,onToggleReadingList:this.handleToggleReadingList,summaryStatus:this.state.summaryStatus,summaryLastError:this.state.summaryLastError,onTriggerSummary:this.handleTriggerSummary})}}const ye=a=>{const e=a.tag,n=I(e.name),t=e.neg_only===!0,i="rel_utag"+(e.name==="all"?" rel_utag_all":"")+(t?" tag-negative":""),s=e.name!=="all",d=e.name==="all"?"\u5305\u542B\u6240\u6709\u6807\u7B7E":`Positive: ${e.pos_n||0} \xB7 Negative: ${e.neg_n||0}`,o=Number(e.pos_n||0),g=Number(e.neg_n||0),l=h=>{h.preventDefault(),h.stopPropagation(),a.onManage&&a.onManage(e)},r=h=>{if(h.preventDefault(),h.stopPropagation(),t){alert("This tag only has negative examples and cannot be used for recommendations.");return}window.location.href=n};return React.createElement("div",{class:i+" enhanced-tag",title:d},React.createElement("span",{class:t?"tag-link tag-link-disabled":"tag-link",title:d,onClick:l},React.createElement("span",{class:"tag-counts"},React.createElement("span",{class:"tag-count tag-count-pos",title:"Positive count"},"+",o),React.createElement("span",{class:"tag-count tag-count-neg",title:"Negative count"},"\u2212",g)),React.createElement("span",{class:"tag-name"},e.name)),s&&React.createElement("div",{class:"tag-actions"},React.createElement("span",{class:"tag-reco",onClick:r,title:"Open recommendations"},"\u2197"),React.createElement("span",{class:"tag-edit",onClick:()=>a.onEdit(e),title:"Edit tag"},"\u270E"),React.createElement("span",{class:"tag-delete",onClick:()=>a.onDelete(e),title:"Delete tag"},"\xD7")))},we=a=>{const e=a.tags,n=e.map((s,d)=>React.createElement(ye,{key:d,tag:s,onEdit:a.onEditTag,onDelete:a.onDeleteTag,onManage:a.onManageTag})),t=()=>{const s=document.getElementById("wordwrap");s.style.display==="block"?s.style.display="none":s.style.display="block"},i=words.length>0?React.createElement("div",{id:"inspect_svm",onClick:t},"inspect"):null;return React.createElement("div",{class:"enhanced-tag-list"},React.createElement("div",{class:"tag-list-actions"},React.createElement("span",{class:"tag-stats-inline"},"(",e.length," tags)"),React.createElement("button",{class:"tag-action-btn add-btn",onClick:a.onAddTag,title:"Add new tag"},"+ Add")),React.createElement("div",{id:"tagList",class:"rel_utags enhanced-tags"},n),i,a.showEditModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseEditModal},React.createElement("div",{class:"modal-content",onClick:s=>s.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,"Edit Tag"),React.createElement("span",{class:"modal-close",onClick:a.onCloseEditModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("div",{class:"form-group"},React.createElement("label",null,"Tag Name:"),React.createElement("input",{type:"text",value:a.editingTagName,onChange:a.onEditingTagNameChange,class:"form-input",placeholder:"Enter new tag name"}))),React.createElement("div",{class:"modal-footer"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onCloseEditModal},"Cancel"),React.createElement("button",{class:"btn btn-primary",onClick:a.onSaveTagEdit},"Save")))),a.showAddModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseAddModal},React.createElement("div",{class:"modal-content",onClick:s=>s.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,"Add Tag"),React.createElement("span",{class:"modal-close",onClick:a.onCloseAddModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("div",{class:"form-group"},React.createElement("label",null,"Tag Name:"),React.createElement("input",{type:"text",value:a.newTagName,onChange:a.onNewTagNameChange,class:"form-input",placeholder:"Enter tag name"}))),React.createElement("div",{class:"modal-footer"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onCloseAddModal},"Cancel"),React.createElement("button",{class:"btn btn-primary",onClick:a.onSaveNewTag},"Save")))),a.showDeleteModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseDeleteModal},React.createElement("div",{class:"modal-content",onClick:s=>s.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,"Confirm Delete"),React.createElement("span",{class:"modal-close",onClick:a.onCloseDeleteModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("p",null,'Are you sure you want to delete tag "',React.createElement("strong",null,a.deletingTag&&a.deletingTag.name),'"?'),React.createElement("p",{class:"warning-text"},"This action is irreversible. All papers under this tag will lose the tag.")),React.createElement("div",{class:"modal-footer"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onCloseDeleteModal},"Cancel"),React.createElement("button",{class:"btn btn-danger",onClick:a.onConfirmDelete},"Delete")))),a.showManageModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseManageModal},React.createElement("div",{class:"modal-content wide tag-manage-modal",onClick:s=>s.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,"Manage Tag: ",a.managingTagName),React.createElement("span",{class:"modal-close",onClick:a.onCloseManageModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("div",{class:"tag-manage-toolbar"},React.createElement("div",{class:"tag-manage-filters"},React.createElement("label",null,"View:"),React.createElement("select",{value:a.manageLabelFilter,onChange:a.onManageLabelFilterChange},React.createElement("option",{value:"all"},"All"),React.createElement("option",{value:"pos"},"Positive"),React.createElement("option",{value:"neg"},"Negative")),React.createElement("input",{type:"text",class:"form-input",placeholder:"Search title / author...",value:a.manageSearchValue,onChange:a.onManageSearchChange})),React.createElement("div",{class:"tag-manage-stats"},React.createElement("span",{class:"tag-manage-stat"},"pos: ",a.managePosTotal),React.createElement("span",{class:"tag-manage-stat"},"neg: ",a.manageNegTotal),React.createElement("span",{class:"tag-manage-stat"},"total: ",a.manageTotalCount))),React.createElement("div",{class:"tag-manage-add"},React.createElement("div",{class:"tag-manage-add-row"},React.createElement("input",{type:"text",class:"form-input tag-manage-add-input",placeholder:"Enter PID(s), e.g. 2501.01234",value:a.manageAddPidsValue,onChange:a.onManageAddPidsChange,onKeyDown:s=>{s.key==="Enter"&&a.manageAddPidsValue.trim()&&(s.preventDefault(),a.onManageAddPids(1))}}),React.createElement("button",{class:"btn btn-primary tag-manage-add-btn",onClick:()=>a.onManageAddPids(1),disabled:!a.manageAddPidsValue.trim(),title:"Add as positive (Enter)"},"+"),React.createElement("button",{class:"btn btn-danger tag-manage-add-btn",onClick:()=>a.onManageAddPids(-1),disabled:!a.manageAddPidsValue.trim(),title:"Add as negative"},"\u2212")),React.createElement("div",{class:"tag-manage-help"},React.createElement("small",null,"Multiple PIDs: separate by comma / space / newline. Enter to add as +. Use buttons for + / \u2212.")),a.managePidPreviewLoading||a.managePidPreviewItems&&a.managePidPreviewItems.length||a.managePidPreviewError?React.createElement("div",{class:"tag-manage-pid-preview"},a.managePidPreviewLoading?React.createElement("div",{class:"tag-manage-pid-preview-loading"},"Previewing\u2026"):null,a.managePidPreviewError?React.createElement("div",{class:"tag-manage-pid-preview-error"},a.managePidPreviewError):null,(a.managePidPreviewItems||[]).slice(0,8).map((s,d)=>React.createElement("div",{key:s.pid+"-"+d,class:"tag-manage-pid-preview-item"+(s.title?"":" not-found")},React.createElement("span",{class:"tag-manage-pid-preview-pid"},s.pid),React.createElement("span",{class:"tag-manage-pid-preview-title"+(s.title?"":" not-found")},s.title||"Not found in database"))),(a.managePidPreviewItems||[]).length>8?React.createElement("div",{class:"tag-manage-pid-preview-more"},"\u2026and ",(a.managePidPreviewItems||[]).length-8," more"):null):null),React.createElement("div",{class:"tag-manage-list"},a.manageLoading?React.createElement("div",{class:"tag-manage-loading"},"Loading\u2026"):(a.manageItems||[]).length===0?React.createElement("div",{class:"tag-manage-empty"},"No papers in this tag."):React.createElement("div",{class:"tag-manage-rows"},(a.manageItems||[]).map((s,d)=>React.createElement("div",{key:s.pid+"-"+d,class:"tag-manage-row"},React.createElement("button",{class:"tag-manage-label "+(s.label===1?"pos":s.label===-1?"neg":"none"),onClick:()=>a.onManageCyclePid(s.pid,s.label),title:"Cycle label"},s.label===1?"+":s.label===-1?"\u2212":"\xB7"),React.createElement("div",{class:"tag-manage-main"},React.createElement("div",{class:"tag-manage-title"},React.createElement("a",{href:"/summary?pid="+encodeURIComponent(s.pid),target:"_blank",rel:"noreferrer"},s.title||s.pid)),React.createElement("div",{class:"tag-manage-meta"},React.createElement("span",{class:"tag-manage-time"},s.time||""),React.createElement("span",{class:"tag-manage-authors",title:s.authors||""},F(s.authors,{maxAuthors:10,head:5,tail:3})))),React.createElement("button",{class:"btn btn-cancel tag-manage-remove",onClick:()=>a.onManageSetPid(s.pid,0)},"Remove")))))),React.createElement("div",{class:"modal-footer"},React.createElement("div",{class:"tag-manage-pagination"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onManagePrevPage,disabled:a.managePageNumber<=1||a.manageLoading},"Prev"),React.createElement("span",{class:"tag-manage-page"},"Page ",a.managePageNumber),React.createElement("button",{class:"btn btn-primary",onClick:a.onManageNextPage,disabled:a.manageLoading||!a.manageHasMore},"Next"))))))};class ve extends React.Component{constructor(e){super(e),this.state={tags:e.tags,showEditModal:!1,showDeleteModal:!1,showAddModal:!1,showManageModal:!1,editingTag:null,editingTagName:"",deletingTag:null,newTagName:"",managingTag:null,manageLabelFilter:"all",manageSearchValue:"",manageItems:[],manageLoading:!1,managePageNumber:1,managePageSize:20,manageTotalCount:0,managePosTotal:0,manageNegTotal:0,manageHasMore:!1,manageAddPidsValue:"",managePidPreviewLoading:!1,managePidPreviewItems:[],managePidPreviewError:""},this.handleEditTag=this.handleEditTag.bind(this),this.handleDeleteTag=this.handleDeleteTag.bind(this),this.handleAddTag=this.handleAddTag.bind(this),this.handleCloseEditModal=this.handleCloseEditModal.bind(this),this.handleCloseDeleteModal=this.handleCloseDeleteModal.bind(this),this.handleCloseAddModal=this.handleCloseAddModal.bind(this),this.handleEditingTagNameChange=this.handleEditingTagNameChange.bind(this),this.handleNewTagNameChange=this.handleNewTagNameChange.bind(this),this.handleSaveTagEdit=this.handleSaveTagEdit.bind(this),this.handleSaveNewTag=this.handleSaveNewTag.bind(this),this.handleConfirmDelete=this.handleConfirmDelete.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleManageTag=this.handleManageTag.bind(this),this.handleCloseManageModal=this.handleCloseManageModal.bind(this),this.handleManageLabelFilterChange=this.handleManageLabelFilterChange.bind(this),this.handleManageSearchChange=this.handleManageSearchChange.bind(this),this.handleManagePrevPage=this.handleManagePrevPage.bind(this),this.handleManageNextPage=this.handleManageNextPage.bind(this),this.handleManageCyclePid=this.handleManageCyclePid.bind(this),this.handleManageSetPid=this.handleManageSetPid.bind(this),this.handleManageAddPidsChange=this.handleManageAddPidsChange.bind(this),this.handleManageAddPids=this.handleManageAddPids.bind(this),this._pidPreviewTimeout=null}componentDidMount(){document.addEventListener("keydown",this.handleKeyDown)}componentDidUpdate(e){e.tags!==this.props.tags&&this.setState({tags:this.props.tags})}componentWillUnmount(){document.removeEventListener("keydown",this.handleKeyDown)}handleKeyDown(e){e.key==="Escape"&&(this.state.showEditModal&&this.handleCloseEditModal(),this.state.showDeleteModal&&this.handleCloseDeleteModal(),this.state.showAddModal&&this.handleCloseAddModal())}handleEditTag(e){this.setState({showEditModal:!0,editingTag:e,editingTagName:e.name})}handleDeleteTag(e){this.setState({showDeleteModal:!0,deletingTag:e})}handleAddTag(){this.setState({showAddModal:!0,newTagName:""})}handleCloseAddModal(){this.setState({showAddModal:!1,newTagName:""})}handleNewTagNameChange(e){this.setState({newTagName:e.target.value})}handleSaveNewTag(){const{newTagName:e}=this.state,n=e.trim();if(!n){alert("Tag name cannot be empty");return}if(n==="all"||n==="null"){alert("Tag name is reserved");return}if(this.state.tags.some(t=>t.name===n)){alert("Tag already exists");return}m("/add_tag/"+encodeURIComponent(n)).then(t=>t.text()).then(t=>{t.startsWith("ok")?(this.setState(i=>{const s=P(i.tags.filter(d=>d.name!=="all").concat([{name:n,n:0}]));return T(s,{renderTags:!1}),{tags:s,showAddModal:!1,newTagName:""}}),console.log("Tag added successfully")):alert("Add failed: "+t)}).catch(t=>{console.error("Error adding tag:",t),alert("Network error, add failed")})}handleCloseEditModal(){this.setState({showEditModal:!1,editingTag:null,editingTagName:""})}handleCloseDeleteModal(){this.setState({showDeleteModal:!1,deletingTag:null})}handleCloseManageModal(){this.setState({showManageModal:!1,managingTag:null,manageItems:[],manageSearchValue:"",manageLabelFilter:"all",managePageNumber:1,manageTotalCount:0,managePosTotal:0,manageNegTotal:0,manageHasMore:!1,manageAddPidsValue:"",managePidPreviewLoading:!1,managePidPreviewItems:[],managePidPreviewError:""})}parsePidInput(e){const n=String(e||"").trim().split(/[\s,\n\r\t;\uFF0C\u3001]+/).map(s=>s.trim()).filter(Boolean),t=new Set,i=[];for(const s of n)if(!t.has(s)&&(t.add(s),i.push(s),i.length>=50))break;return i}async fetchPidPreview(e){const n=Array.isArray(e)?e:[];if(n.length===0){this.setState({managePidPreviewLoading:!1,managePidPreviewItems:[],managePidPreviewError:""});return}this.setState({managePidPreviewLoading:!0,managePidPreviewError:""});try{const i=await(await m("/api/paper_titles",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pids:n})})).json().catch(()=>null);if(!i||!i.success)throw new Error(i&&i.error?i.error:"Failed to preview PIDs");const s=Array.isArray(i.items)?i.items:[];this.setState({managePidPreviewItems:s,managePidPreviewLoading:!1})}catch(t){const i=c.handleApiError(t,"Preview PIDs");this.setState({managePidPreviewLoading:!1,managePidPreviewItems:[],managePidPreviewError:i})}}async fetchManageMembers(e={}){const n=e.managingTag!==void 0?e.managingTag:this.state.managingTag;if(!n||!n.name)return;const t=e.managePageNumber!==void 0?e.managePageNumber:this.state.managePageNumber,i=e.manageLabelFilter!==void 0?e.manageLabelFilter:this.state.manageLabelFilter,s=e.managePageSize!==void 0?e.managePageSize:this.state.managePageSize,d=e.manageSearchValue!==void 0?e.manageSearchValue:this.state.manageSearchValue;this.setState({manageLoading:!0});try{const o=new URLSearchParams;o.set("tag",n.name),o.set("label",i),o.set("page_number",String(t)),o.set("page_size",String(s)),d&&d.trim()&&o.set("search",d.trim());const l=await(await fetch("/api/tag_members?"+o.toString(),{credentials:"same-origin"})).json();if(!l||!l.success)throw new Error(l&&l.error?l.error:"Failed to load tag members");const r=Array.isArray(l.items)?l.items:[];this.setState({manageItems:r,manageTotalCount:l.total_count||0,managePosTotal:l.pos_total||0,manageNegTotal:l.neg_total||0,manageHasMore:t*s<(l.total_count||0)})}catch(o){const g=c.handleApiError(o,"Fetch Tag Members");console.error("Failed to fetch tag members:",o),alert("Failed to load tag members: "+g)}finally{this.setState({manageLoading:!1})}}handleManageTag(e){!e||!e.name||e.name==="all"||this.setState({showManageModal:!0,managingTag:e,manageLabelFilter:"all",manageSearchValue:"",manageItems:[],managePageNumber:1,manageTotalCount:0,managePosTotal:0,manageNegTotal:0,manageHasMore:!1,manageAddPidsValue:""},()=>this.fetchManageMembers({managingTag:e,managePageNumber:1,manageLabelFilter:"all",manageSearchValue:""}))}handleManageLabelFilterChange(e){const n=e.target.value;this.setState({manageLabelFilter:n,managePageNumber:1},()=>{this.fetchManageMembers({manageLabelFilter:n,managePageNumber:1})})}handleManageSearchChange(e){const n=e.target.value;this.setState({manageSearchValue:n}),this._searchTimeout&&clearTimeout(this._searchTimeout),this._searchTimeout=setTimeout(()=>{this.setState({managePageNumber:1},()=>{this.fetchManageMembers({manageSearchValue:n,managePageNumber:1})})},300)}handleManagePrevPage(){if(this.state.manageLoading)return;const e=Math.max(1,(this.state.managePageNumber||1)-1);e!==this.state.managePageNumber&&this.setState({managePageNumber:e},()=>this.fetchManageMembers({managePageNumber:e}))}handleManageNextPage(){if(this.state.manageLoading||!this.state.manageHasMore)return;const e=(this.state.managePageNumber||1)+1;this.setState({managePageNumber:e},()=>this.fetchManageMembers({managePageNumber:e}))}async handleManageSetPid(e,n){const t=this.state.managingTag;if(!(!t||!t.name))try{const s=await(await m("/api/tag_feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:e,tag:t.name,label:n})})).json();if(!s||!s.success)throw new Error(s&&s.error?s.error:"Update failed");await this.fetchManageMembers()}catch(i){const s=c.handleApiError(i,"Update Tag Feedback");console.error("Failed to update tag feedback:",i),alert("Failed to update tag: "+s)}}handleManageCyclePid(e,n){const t=Number(n||0),i=t===1?-1:t===-1?0:1;this.handleManageSetPid(e,i)}handleManageAddPidsChange(e){const n=e.target.value;this.setState({manageAddPidsValue:n}),this._pidPreviewTimeout&&clearTimeout(this._pidPreviewTimeout),this._pidPreviewTimeout=setTimeout(()=>{const t=this.parsePidInput(n);this.fetchPidPreview(t)},250)}async handleManageAddPids(e){const n=this.state.managingTag;if(!n||!n.name)return;const t=(this.state.manageAddPidsValue||"").trim();if(!t)return;const i=this.parsePidInput(t).slice(0,200);if(i.length!==0){this.setState({manageLoading:!0});try{const s=i.map(g=>m("/api/tag_feedback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pid:g,tag:n.name,label:e})}).then(l=>l.json()).catch(()=>null)),o=(await Promise.all(s)).filter(g=>!g||!g.success).length;o&&alert(`Added with ${o} failures (check PIDs).`),this.setState({manageAddPidsValue:"",managePidPreviewItems:[],managePidPreviewError:""}),await this.fetchManageMembers()}finally{this.setState({manageLoading:!1})}}}handleEditingTagNameChange(e){this.setState({editingTagName:e.target.value})}handleSaveTagEdit(){const{editingTag:e,editingTagName:n}=this.state;if(!n.trim()){alert("Tag name cannot be empty");return}const t=n.trim();if(this.state.tags.some(i=>i.name===t&&i.name!==e.name)){alert("Tag already exists");return}m("/rename/"+encodeURIComponent(e.name)+"/"+encodeURIComponent(t)).then(i=>i.text()).then(i=>{i.startsWith("ok")?(this.setState(s=>{const d=P(s.tags.map(g=>g.name===e.name?S(M({},g),{name:t}):g)),o=Ee(combined_tags,e.name,t);return f(o,{renderCombined:!1}),T(d,{renderTags:!1}),{tags:d,showEditModal:!1,editingTag:null,editingTagName:""}}),console.log("Tag renamed successfully")):alert("Rename failed: "+i)}).catch(i=>{console.error("Error renaming tag:",i),alert("Network error, rename failed")})}handleConfirmDelete(){const{deletingTag:e}=this.state;m("/del/"+encodeURIComponent(e.name)).then(n=>n.text()).then(n=>{n.startsWith("ok")?(this.setState(t=>{const i=P(t.tags.filter(d=>d.name!==e.name)),s=De(combined_tags,e.name);return f(s,{renderCombined:!1}),T(i,{renderTags:!1}),{tags:i,showDeleteModal:!1,deletingTag:null}}),console.log("Tag deleted successfully")):alert("Delete failed: "+n)}).catch(n=>{console.error("Error deleting tag:",n),alert("Network error, delete failed")})}render(){const e=this.state.managingTag&&this.state.managingTag.name?this.state.managingTag.name:"";return React.createElement(we,{tags:this.state.tags,onEditTag:this.handleEditTag,onDeleteTag:this.handleDeleteTag,onAddTag:this.handleAddTag,onManageTag:this.handleManageTag,showEditModal:this.state.showEditModal,showDeleteModal:this.state.showDeleteModal,showAddModal:this.state.showAddModal,editingTagName:this.state.editingTagName,newTagName:this.state.newTagName,deletingTag:this.state.deletingTag,onCloseEditModal:this.handleCloseEditModal,onCloseDeleteModal:this.handleCloseDeleteModal,onCloseAddModal:this.handleCloseAddModal,onEditingTagNameChange:this.handleEditingTagNameChange,onNewTagNameChange:this.handleNewTagNameChange,onSaveTagEdit:this.handleSaveTagEdit,onSaveNewTag:this.handleSaveNewTag,onConfirmDelete:this.handleConfirmDelete,showManageModal:this.state.showManageModal,managingTagName:e,manageLabelFilter:this.state.manageLabelFilter,manageSearchValue:this.state.manageSearchValue,manageItems:this.state.manageItems,manageLoading:this.state.manageLoading,managePageNumber:this.state.managePageNumber,manageTotalCount:this.state.manageTotalCount,managePosTotal:this.state.managePosTotal,manageNegTotal:this.state.manageNegTotal,manageHasMore:this.state.manageHasMore,manageAddPidsValue:this.state.manageAddPidsValue,managePidPreviewLoading:this.state.managePidPreviewLoading,managePidPreviewItems:this.state.managePidPreviewItems,managePidPreviewError:this.state.managePidPreviewError,onCloseManageModal:this.handleCloseManageModal,onManageLabelFilterChange:this.handleManageLabelFilterChange,onManageSearchChange:this.handleManageSearchChange,onManagePrevPage:this.handleManagePrevPage,onManageNextPage:this.handleManageNextPage,onManageCyclePid:this.handleManageCyclePid,onManageSetPid:this.handleManageSetPid,onManageAddPidsChange:this.handleManageAddPidsChange,onManageAddPids:this.handleManageAddPids})}}const Te=a=>{const e=a.comtag,n=I(e.name,{logic:"and"});return React.createElement("div",{class:"rel_utag rel_utag_all enhanced-combined-tag"},React.createElement("a",{href:n,class:"combined-tag-link"},e.name),React.createElement("div",{class:"combined-tag-actions"},React.createElement("span",{class:"combined-tag-edit",onClick:()=>a.onEdit(e),title:"Edit combined tag"},"\u270E"),React.createElement("span",{class:"combined-tag-delete",onClick:()=>a.onDelete(e),title:"Delete combined tag"},"\xD7")))},pe=a=>{const e=a.combined_tags,n=e.map((t,i)=>React.createElement(Te,{key:i,comtag:t,onEdit:a.onEditCombinedTag,onDelete:a.onDeleteCombinedTag}));return React.createElement("div",{class:"enhanced-combined-tag-list"},React.createElement("div",{class:"combined-tag-list-actions"},React.createElement("span",{class:"tag-stats-inline"},"(",e.length," combined tags)"),React.createElement("button",{class:"tag-action-btn add-btn",onClick:a.onAddCombinedTag,title:"Add new combined tag"},"+ Add")),React.createElement("div",{id:"combinedTagList",class:"rel_utags enhanced-combined-tags"},n),a.showAddEditModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseAddEditModal},React.createElement("div",{class:"modal-content wide",onClick:t=>t.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,a.editingCombinedTag?"Edit Combined Tag":"Add Combined Tag"),React.createElement("span",{class:"modal-close",onClick:a.onCloseAddEditModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("div",{class:"form-group"},React.createElement("label",null,"Select tags to combine:"),React.createElement(O,{selectedTags:a.selectedTagsForCombination,negativeTags:[],availableTags:a.availableTagsForCombination,isOpen:a.combinationDropdownOpen,onToggle:a.onToggleCombinationDropdown,onTagCycle:a.onCombinationTagToggle,onClearTag:a.onRemoveCombinationTag,newTagValue:"",onNewTagChange:()=>{},onAddNewTag:()=>{},dropdownId:"combination-dropdown",searchValue:a.combinationSearchValue,onSearchChange:a.onCombinationSearchChange,showNewTagInput:!1})),a.selectedTagsForCombination.length>0&&React.createElement("div",{class:"tag-combination-preview"},React.createElement("h4",null,"Preview Combination:"),React.createElement("div",{class:"tag-combination-preview-tags"},a.selectedTagsForCombination.map((t,i)=>React.createElement("span",{key:i,class:"tag-combination-preview-tag"},t))),React.createElement("p",{style:{marginTop:"10px",fontSize:"12px",color:"var(--text-color)",opacity:"0.8"}},"Combination Name: ",a.selectedTagsForCombination.join(", ")))),React.createElement("div",{class:"modal-footer"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onCloseAddEditModal},"Cancel"),React.createElement("button",{class:"btn btn-primary",onClick:a.onSaveCombinedTag,disabled:a.selectedTagsForCombination.length<2},a.editingCombinedTag?"Save":"Create")))),a.showDeleteModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseDeleteModal},React.createElement("div",{class:"modal-content",onClick:t=>t.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,"Confirm Delete"),React.createElement("span",{class:"modal-close",onClick:a.onCloseDeleteModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("p",null,'Are you sure you want to delete combined tag "',React.createElement("strong",null,a.deletingCombinedTag&&a.deletingCombinedTag.name),'"?'),React.createElement("p",{class:"warning-text"},"This action is irreversible.")),React.createElement("div",{class:"modal-footer"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onCloseDeleteModal},"Cancel"),React.createElement("button",{class:"btn btn-danger",onClick:a.onConfirmDelete},"Delete")))))};class Me extends React.Component{constructor(e){super(e),this.state={combined_tags:e.combined_tags,tags:e.tags,showAddEditModal:!1,showDeleteModal:!1,editingCombinedTag:null,deletingCombinedTag:null,selectedTagsForCombination:[],combinationDropdownOpen:!1,combinationSearchValue:""},this.handleAddCombinedTag=this.handleAddCombinedTag.bind(this),this.handleEditCombinedTag=this.handleEditCombinedTag.bind(this),this.handleDeleteCombinedTag=this.handleDeleteCombinedTag.bind(this),this.handleCloseAddEditModal=this.handleCloseAddEditModal.bind(this),this.handleCloseDeleteModal=this.handleCloseDeleteModal.bind(this),this.handleSaveCombinedTag=this.handleSaveCombinedTag.bind(this),this.handleConfirmDelete=this.handleConfirmDelete.bind(this),this.handleToggleCombinationDropdown=this.handleToggleCombinationDropdown.bind(this),this.handleCombinationTagToggle=this.handleCombinationTagToggle.bind(this),this.handleRemoveCombinationTag=this.handleRemoveCombinationTag.bind(this),this.handleCombinationSearchChange=this.handleCombinationSearchChange.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}componentDidMount(){document.addEventListener("mousedown",this.handleClickOutside),document.addEventListener("keydown",this.handleKeyDown)}componentDidUpdate(e){const n=e.tags!==this.props.tags,t=e.combined_tags!==this.props.combined_tags;(n||t)&&this.setState({tags:this.props.tags,combined_tags:this.props.combined_tags})}componentWillUnmount(){document.removeEventListener("mousedown",this.handleClickOutside),document.removeEventListener("keydown",this.handleKeyDown)}handleKeyDown(e){e.key==="Escape"&&(this.state.showAddEditModal&&this.handleCloseAddEditModal(),this.state.showDeleteModal&&this.handleCloseDeleteModal(),this.state.combinationDropdownOpen&&this.setState({combinationDropdownOpen:!1}))}handleClickOutside(e){const n=document.getElementById("combination-dropdown");n&&!n.contains(e.target)&&this.setState({combinationDropdownOpen:!1})}handleAddCombinedTag(){this.setState({showAddEditModal:!0,editingCombinedTag:null,selectedTagsForCombination:[],combinationSearchValue:""})}handleEditCombinedTag(e){const n=e.name.split(",").map(t=>t.trim()).filter(t=>t.length>0);this.setState({showAddEditModal:!0,editingCombinedTag:e,selectedTagsForCombination:n,combinationSearchValue:""})}handleDeleteCombinedTag(e){this.setState({showDeleteModal:!0,deletingCombinedTag:e})}handleCloseAddEditModal(){this.setState({showAddEditModal:!1,editingCombinedTag:null,selectedTagsForCombination:[],combinationDropdownOpen:!1,combinationSearchValue:""})}handleCloseDeleteModal(){this.setState({showDeleteModal:!1,deletingCombinedTag:null})}handleSaveCombinedTag(){const{editingCombinedTag:e,selectedTagsForCombination:n}=this.state;if(n.length<2){alert("Please select at least two tags to combine");return}const t=n.join(", ");if(e){if(e.name===t){this.handleCloseAddEditModal();return}m("/rename_ctag/"+encodeURIComponent(e.name)+"/"+encodeURIComponent(t)).then(i=>i.text()).then(i=>{if(i.includes("ok"))this.setState(s=>{const d=Ae(s.combined_tags,e.name,t);return f(d,{renderCombined:!1}),{combined_tags:d,showAddEditModal:!1,editingCombinedTag:null,selectedTagsForCombination:[],combinationDropdownOpen:!1,combinationSearchValue:""}}),console.log("Combined tag edited successfully");else throw new Error("Rename failed: "+i)}).catch(i=>{console.error("Error editing combined tag:",i),alert("Edit failed: "+i.message)})}else m("/add_ctag/"+encodeURIComponent(t)).then(i=>i.text()).then(i=>{i.includes("ok")?(this.setState(s=>{const d=s.combined_tags.concat([{name:t}]);return f(d,{renderCombined:!1}),{combined_tags:d,showAddEditModal:!1,selectedTagsForCombination:[],combinationDropdownOpen:!1,combinationSearchValue:""}}),console.log("Combined tag added successfully")):alert("Add failed: "+i)}).catch(i=>{console.error("Error adding combined tag:",i),alert("Network error, add failed")})}handleConfirmDelete(){const{deletingCombinedTag:e}=this.state;m("/del_ctag/"+encodeURIComponent(e.name)).then(n=>n.text()).then(n=>{n.includes("ok")?(this.setState(t=>{const i=t.combined_tags.filter(s=>s.name!==e.name);return f(i,{renderCombined:!1}),{combined_tags:i,showDeleteModal:!1,deletingCombinedTag:null}}),console.log("Combined tag deleted successfully")):alert("Delete failed: "+n)}).catch(n=>{console.error("Error deleting combined tag:",n),alert("Network error, delete failed")})}handleToggleCombinationDropdown(){this.setState(e=>({combinationDropdownOpen:!e.combinationDropdownOpen,combinationSearchValue:e.combinationDropdownOpen?e.combinationSearchValue:""}))}handleCombinationTagToggle(e){this.setState(n=>({selectedTagsForCombination:n.selectedTagsForCombination.includes(e)?n.selectedTagsForCombination.filter(i=>i!==e):[...n.selectedTagsForCombination,e]}))}handleRemoveCombinationTag(e){this.setState(n=>({selectedTagsForCombination:n.selectedTagsForCombination.filter(t=>t!==e)}))}handleCombinationSearchChange(e){this.setState({combinationSearchValue:e.target.value})}render(){const e=this.state.tags.filter(n=>n.name!=="all"&&!n.neg_only).map(n=>n.name);return React.createElement(pe,{combined_tags:this.state.combined_tags,onAddCombinedTag:this.handleAddCombinedTag,onEditCombinedTag:this.handleEditCombinedTag,onDeleteCombinedTag:this.handleDeleteCombinedTag,showAddEditModal:this.state.showAddEditModal,showDeleteModal:this.state.showDeleteModal,editingCombinedTag:this.state.editingCombinedTag,deletingCombinedTag:this.state.deletingCombinedTag,onCloseAddEditModal:this.handleCloseAddEditModal,onCloseDeleteModal:this.handleCloseDeleteModal,onSaveCombinedTag:this.handleSaveCombinedTag,onConfirmDelete:this.handleConfirmDelete,selectedTagsForCombination:this.state.selectedTagsForCombination,availableTagsForCombination:e,combinationDropdownOpen:this.state.combinationDropdownOpen,onToggleCombinationDropdown:this.handleToggleCombinationDropdown,onCombinationTagToggle:this.handleCombinationTagToggle,onRemoveCombinationTag:this.handleRemoveCombinationTag,combinationSearchValue:this.state.combinationSearchValue,onCombinationSearchChange:this.handleCombinationSearchChange})}}const Se=a=>{const e=a.jkey,n=ne(e.name),t="rel_ukey"+(e.name==="Artificial general intelligence"?" rel_ukey_all":""),i=e.name!=="Artificial general intelligence";return React.createElement("div",{class:t+" enhanced-keyword"},React.createElement("a",{href:n,class:"keyword-link"},e.name),i&&React.createElement("div",{class:"keyword-actions"},React.createElement("span",{class:"keyword-edit",onClick:()=>a.onEdit(e),title:"Edit keyword"},"\u270E"),React.createElement("span",{class:"keyword-delete",onClick:()=>a.onDelete(e),title:"Delete keyword"},"\xD7")))},Pe=a=>{const e=a.keys,n=e.map((t,i)=>React.createElement(Se,{key:i,jkey:t,onEdit:a.onEditKey,onDelete:a.onDeleteKey}));return React.createElement("div",{class:"enhanced-keyword-list"},React.createElement("div",{class:"keyword-list-actions"},React.createElement("span",{class:"tag-stats-inline"},"(",e.length," keywords)"),React.createElement("button",{class:"tag-action-btn add-btn",onClick:a.onAddKey,title:"Add new keyword"},"+ Add")),React.createElement("div",{id:"keyList",class:"rel_utags enhanced-keywords"},n),a.showAddModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseAddModal},React.createElement("div",{class:"modal-content",onClick:t=>t.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,"Add Keyword"),React.createElement("span",{class:"modal-close",onClick:a.onCloseAddModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("div",{class:"form-group"},React.createElement("label",null,"Keyword Name:"),React.createElement("input",{type:"text",value:a.newKeyName,onChange:a.onNewKeyNameChange,class:"form-input",placeholder:"Enter keyword name"}))),React.createElement("div",{class:"modal-footer"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onCloseAddModal},"Cancel"),React.createElement("button",{class:"btn btn-primary",onClick:a.onSaveNewKey},"Save")))),a.showEditModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseEditModal},React.createElement("div",{class:"modal-content",onClick:t=>t.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,"Edit Keyword"),React.createElement("span",{class:"modal-close",onClick:a.onCloseEditModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("div",{class:"form-group"},React.createElement("label",null,"Keyword Name:"),React.createElement("input",{type:"text",value:a.editingKeyName,onChange:a.onEditingKeyNameChange,class:"form-input",placeholder:"Enter new keyword name"}))),React.createElement("div",{class:"modal-footer"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onCloseEditModal},"Cancel"),React.createElement("button",{class:"btn btn-primary",onClick:a.onSaveKeyEdit},"Save")))),a.showDeleteModal&&React.createElement("div",{class:"modal-overlay",onClick:a.onCloseDeleteModal},React.createElement("div",{class:"modal-content",onClick:t=>t.stopPropagation()},React.createElement("div",{class:"modal-header"},React.createElement("h3",null,"Confirm Delete"),React.createElement("span",{class:"modal-close",onClick:a.onCloseDeleteModal},"\xD7")),React.createElement("div",{class:"modal-body"},React.createElement("p",null,'Are you sure you want to delete keyword "',React.createElement("strong",null,a.deletingKey&&a.deletingKey.name),'"?'),React.createElement("p",{class:"warning-text"},"This action is irreversible, all data related to this keyword will be deleted.")),React.createElement("div",{class:"modal-footer"},React.createElement("button",{class:"btn btn-cancel",onClick:a.onCloseDeleteModal},"Cancel"),React.createElement("button",{class:"btn btn-danger",onClick:a.onConfirmDelete},"Delete")))))};class ke extends React.Component{constructor(e){super(e),this.state={keys:e.keys,showEditModal:!1,showDeleteModal:!1,showAddModal:!1,editingKey:null,editingKeyName:"",deletingKey:null,newKeyName:""},this.handleEditKey=this.handleEditKey.bind(this),this.handleDeleteKey=this.handleDeleteKey.bind(this),this.handleAddKey=this.handleAddKey.bind(this),this.handleCloseEditModal=this.handleCloseEditModal.bind(this),this.handleCloseDeleteModal=this.handleCloseDeleteModal.bind(this),this.handleCloseAddModal=this.handleCloseAddModal.bind(this),this.handleEditingKeyNameChange=this.handleEditingKeyNameChange.bind(this),this.handleNewKeyNameChange=this.handleNewKeyNameChange.bind(this),this.handleSaveKeyEdit=this.handleSaveKeyEdit.bind(this),this.handleSaveNewKey=this.handleSaveNewKey.bind(this),this.handleConfirmDelete=this.handleConfirmDelete.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this)}componentDidMount(){document.addEventListener("keydown",this.handleKeyDown)}componentDidUpdate(e){e.keys!==this.props.keys&&this.setState({keys:this.props.keys})}componentWillUnmount(){document.removeEventListener("keydown",this.handleKeyDown)}handleKeyDown(e){e.key==="Escape"&&(this.state.showEditModal&&this.handleCloseEditModal(),this.state.showDeleteModal&&this.handleCloseDeleteModal(),this.state.showAddModal&&this.handleCloseAddModal())}handleEditKey(e){this.setState({showEditModal:!0,editingKey:e,editingKeyName:e.name})}handleDeleteKey(e){this.setState({showDeleteModal:!0,deletingKey:e})}handleAddKey(){this.setState({showAddModal:!0,newKeyName:""})}handleCloseAddModal(){this.setState({showAddModal:!1,newKeyName:""})}handleNewKeyNameChange(e){this.setState({newKeyName:e.target.value})}handleSaveNewKey(){const{newKeyName:e}=this.state;if(!e.trim()){alert("Keyword name cannot be empty");return}const n=e.trim();if(this.state.keys.some(t=>t.name===n)){alert("Keyword already exists");return}m("/add_key/"+encodeURIComponent(n)).then(t=>t.text()).then(t=>{t.startsWith("ok")?(this.setState(i=>{const s=[...i.keys,{name:n,pids:[]}];return k(s,{renderKeys:!1}),{keys:s,showAddModal:!1,newKeyName:""}}),console.log("Keyword added successfully")):alert("Failed to add keyword: "+t)}).catch(t=>{console.error("Error adding keyword:",t),alert("Network error, failed to add keyword")})}handleCloseEditModal(){this.setState({showEditModal:!1,editingKey:null,editingKeyName:""})}handleCloseDeleteModal(){this.setState({showDeleteModal:!1,deletingKey:null})}handleEditingKeyNameChange(e){this.setState({editingKeyName:e.target.value})}handleSaveKeyEdit(){const{editingKey:e,editingKeyName:n}=this.state;if(!n.trim()){alert("Keyword name cannot be empty");return}const t=n.trim();if(this.state.keys.some(i=>i.name===t&&i.name!==e.name)){alert("Keyword already exists");return}m("/rename_key/"+encodeURIComponent(e.name)+"/"+encodeURIComponent(t)).then(i=>i.text()).then(i=>{i.startsWith("ok")?(this.setState(s=>{const d=s.keys.map(o=>o.name===e.name?S(M({},o),{name:t}):o);return k(d,{renderKeys:!1}),{keys:d,showEditModal:!1,editingKey:null,editingKeyName:""}}),console.log("Keyword renamed successfully")):alert("Rename failed: "+i)}).catch(i=>{console.error("Error renaming keyword:",i),alert("Rename failed: "+i.message)})}handleConfirmDelete(){const{deletingKey:e}=this.state;m("/del_key/"+encodeURIComponent(e.name)).then(n=>n.text()).then(n=>{n.startsWith("ok")?(this.setState(t=>{const i=t.keys.filter(s=>s.name!==e.name);return k(i,{renderKeys:!1}),{keys:i,showDeleteModal:!1,deletingKey:null}}),console.log("Keyword deleted successfully")):alert("Delete failed: "+n)}).catch(n=>{console.error("Error deleting keyword:",n),alert("Network error, delete failed")})}render(){return React.createElement(Pe,{keys:this.state.keys,onEditKey:this.handleEditKey,onDeleteKey:this.handleDeleteKey,onAddKey:this.handleAddKey,showEditModal:this.state.showEditModal,showDeleteModal:this.state.showDeleteModal,showAddModal:this.state.showAddModal,editingKeyName:this.state.editingKeyName,newKeyName:this.state.newKeyName,deletingKey:this.state.deletingKey,onCloseEditModal:this.handleCloseEditModal,onCloseDeleteModal:this.handleCloseDeleteModal,onCloseAddModal:this.handleCloseAddModal,onEditingKeyNameChange:this.handleEditingKeyNameChange,onNewKeyNameChange:this.handleNewKeyNameChange,onSaveKeyEdit:this.handleSaveKeyEdit,onSaveNewKey:this.handleSaveNewKey,onConfirmDelete:this.handleConfirmDelete})}}function P(a){const n=(a||[]).filter(t=>t&&t.name&&t.name!=="all").map(t=>{const i=t.pos_n!==void 0?Number(t.pos_n||0):void 0,s=t.neg_n!==void 0?Number(t.neg_n||0):void 0,d=i!==void 0&&s!==void 0?i+s:Number(t.n||0),o=t.neg_only!==void 0?!!t.neg_only:i!==void 0&&s!==void 0?i===0&&s>0:!1;return{name:t.name,n:d,pos_n:i!==void 0?i:t.pos_n||0,neg_n:s!==void 0?s:t.neg_n||0,neg_only:o}});return n.length>0&&n.push({name:"all"}),n.sort((t,i)=>t.name.localeCompare(i.name)),n}function C(a){const e=new Set,n=[];return(a||[]).forEach(t=>{const i=t&&t.name?t.name:"";!i||e.has(i)||(e.add(i),n.push({name:i}))}),n.sort((t,i)=>t.name.localeCompare(i.name)),n}function Ee(a,e,n){if(!e||!n)return C(a);const t=new Set,i=[];return(a||[]).forEach(s=>{const d=s&&s.name?s.name:"";if(!d)return;const o=d.split(",").map(r=>r.trim()).filter(Boolean);if(o.length===0)return;const l=(o.includes(e)?o.map(r=>r===e?n:r):o).join(", ");t.has(l)||(t.add(l),i.push({name:l}))}),i}function De(a,e){if(!e)return C(a);const n=(a||[]).filter(t=>!(t&&t.name?t.name:"").split(",").map(d=>d.trim()).filter(Boolean).includes(e));return C(n)}function Ae(a,e,n){if(!e||!n)return C(a);const t=(a||[]).map(i=>i&&i.name===e?{name:n}:i);return C(t)}function T(a,e){const n=e||{};tags=P(a),n.renderTags!==!1&&B(),n.renderPaper!==!1&&u(),n.renderCombined!==!1&&D()}function f(a,e){const n=e||{};combined_tags=C(a),n.renderCombined!==!1&&D()}function k(a,e){const n=e||{};keys=Array.isArray(a)?a.slice():[],keys.sort((t,i)=>t.name.localeCompare(i.name)),n.renderKeys!==!1&&z()}function _e(a,e,n){if(!a||a==="all")return;const t=e||0,i=n||0;if(!t&&!i)return;const s=(tags||[]).filter(r=>r&&r.name&&r.name!=="all");let d=!1,o=!1,g=!1;const l=s.map(r=>{if(r.name!==a)return r;d=!0;const h=r.pos_n||0,p=r.neg_n||0,y=Math.max(0,h+t),b=Math.max(0,p+i),w=y+b;return h+p>0&&w===0&&(g=!0),S(M({},r),{n:w,pos_n:y,neg_n:b,neg_only:y===0&&b>0})});if(!d&&(t>0||i>0)){const r=Math.max(0,t),h=Math.max(0,i);l.push({name:a,n:r+h,pos_n:r,neg_n:h,neg_only:r===0&&h>0}),o=!0}T(l,{renderPaper:o||g})}let E=new Set;function Ne(){return user?fetch("/api/readinglist/list",{credentials:"same-origin"}).then(a=>a.json()).then(a=>{a.success&&a.items&&(E=new Set(a.items.map(e=>e.pid)))}).catch(a=>{console.warn("Failed to fetch reading list:",a)}):Promise.resolve()}function Ke(a){return E.has(a)}function U(a){E.add(a)}function j(a){E.delete(a)}const N=document.getElementById("wrap"),K=document.getElementById("tagwrap"),L=document.getElementById("keywrap"),x=document.getElementById("tagcombwrap");function u(){N&&ReactDOM.render(React.createElement(fe,{papers,tags}),N)}function B(){K&&ReactDOM.render(React.createElement(ve,{tags}),K)}function z(){L&&ReactDOM.render(React.createElement(ke,{keys}),L)}function D(){x&&ReactDOM.render(React.createElement(Me,{combined_tags,tags}),x)}Ne().then(()=>{u(),B(),z(),D(),ce()});})();
