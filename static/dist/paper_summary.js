"use strict";(()=>{var c=window.ArxivSanityCommon,y=c.getCsrfToken,I=c.csrfFetch,M=c.formatAuthorsText,l=c.escapeHtml,T=window.ArxivSanitySummaryMarkdown,b=T.renderSummaryMarkdown,D=c.setupUserEventStream,G=c.registerEventHandler;class C{constructor(){this.loading=!1,this.error=null,this.content=null,this.paper=null,this.pid=null,this.meta=null,this.models=[],this.modelsError=null,this.regenerating=!1,this.selectedModel="",this.autoRetryCount=0,this.autoRetryTimer=null,this.maxAutoRetries=5,this.notice="",this.clearing=!1,this.defaultModel="",this.pendingConfirm=null,this.requestSeq=0,this.pendingGenerationModel="",this.inflightModels=Object.create(null),this.contentModel=""}setState(e){Object.assign(this,e),this.render()}render(){const e=document.getElementById("wrap");if(!e)return;const t=this.getHTML();if(this.content){e.innerHTML=t;const a=e.querySelector(".summary-markdown"),n=e.querySelector(".summary-toc");a&&b(this.content,a,n)}else e.innerHTML=t,this.renderMath();typeof user!="undefined"&&user&&R()}renderMath(){typeof MathJax!="undefined"&&setTimeout(()=>{MathJax.typeset?MathJax.typeset():MathJax.typesetPromise&&MathJax.typesetPromise().catch(e=>{console.warn("MathJax rendering error:",e)})},100)}getCurrentModel(){return this.selectedModel||""}isCurrentModelGenerating(){const e=String(this.getCurrentModel()||"").trim();return e?!!(this.pendingGenerationModel&&String(this.pendingGenerationModel)===e||this.inflightModels&&this.inflightModels[e]):!1}getSummaryModel(){return""}clearAutoRetry(){this.autoRetryTimer&&(clearTimeout(this.autoRetryTimer),this.autoRetryTimer=null)}scheduleAutoRetry(e,t={}){if(this.autoRetryCount>=this.maxAutoRetries)return;this.autoRetryCount+=1;const a=Math.min(15e3,5e3+this.autoRetryCount*2e3);this.clearAutoRetry(),this.autoRetryTimer=setTimeout(()=>{const n=String(t.model||"").trim();n&&String(this.getCurrentModel()||"")!==n||n&&this.pendingGenerationModel&&this.pendingGenerationModel!==n||this.loadSummary(e,{model:n||"",force_regenerate:!1})},a)}formatTimestamp(e){if(e==null||Number.isNaN(Number(e)))return"";const t=new Date(Number(e)*1e3);return Number.isNaN(t.getTime())?"":t.toLocaleString()}renderModelOptions(){const e=this.getCurrentModel();if(!Array.isArray(this.models)||this.models.length===0){const n=e?`Use ${l(e)}`:"Default (server configured)";return`<option value="${e?l(e):""}">${n}</option>`}let t=this.models.map(n=>{const s=String(n.id||""),o=l(s),h=s===String(e||"")?" selected":"";return`<option value="${o}"${h}>${o}</option>`}).join("");const a=this.models.some(n=>String(n.id||"")===String(e||""));if(e&&!a){const n=l(e);t+=`<option value="${n}" selected>${n}</option>`}return t}renderActions(){const e=this.loading||this.clearing||this.isCurrentModelGenerating()?"disabled":"",t=this.clearing?"disabled":"",a=this.clearing?"disabled":"",n=this.regenerating?"Generating...":"Generate",s=this.renderModelOptions(),o=this.modelsError?`<div class="summary-note" style="color: #d9534f;" role="status" aria-live="polite">${l(this.modelsError)}</div>`:"",h=this.notice?`<div class="summary-note" style="color: #b8860b;" role="status" aria-live="polite">${l(this.notice)}</div>`:"",u=this.getCurrentModel(),f=u?l(u):"current model",g=this.isCurrentModelGenerating()?'<p class="confirm-warning">Note: generation for this model is currently running. Clearing does not cancel it; it may recreate cache when finished.</p>':"";return`
            <div class="summary-actions">
                <label class="summary-action-label" for="model-select">Model</label>
                <select id="model-select" class="summary-model-select" onchange="summaryApp.handleModelChange(event)" ${a}>
                    ${s}
                </select>
                <button onclick="summaryApp.regenerate()" class="summary-action-btn" ${e}>
                    ${n}
                </button>
                <div class="summary-btn-group">
                    <button onclick="summaryApp.requestClearModel()" class="summary-action-btn summary-btn-warning" ${t} title="Clear summary for current model only">
                        ${this.clearing==="model"?"Clearing...":"Clear Current Summary"}
                    </button>
                    ${this.pendingConfirm==="clearModel"?`
                        <div class="confirm-popup" role="dialog" aria-labelledby="confirm-title">
                            <div class="confirm-content">
                                <strong id="confirm-title">Clear summary for ${f}?</strong>
                                <p>This will only remove the summary generated by this model.</p>
                                ${g}
                                <div class="confirm-actions">
                                    <button onclick="summaryApp.confirmClearModel()" class="confirm-btn confirm-yes">\u786E\u5B9A</button>
                                    <button onclick="summaryApp.cancelConfirm()" class="confirm-btn confirm-no">\u53D6\u6D88</button>
                                </div>
                            </div>
                        </div>
                    `:""}
                </div>
                <div class="summary-btn-group">
                    <button onclick="summaryApp.requestClearAll()" class="summary-action-btn summary-btn-danger" ${t} title="Clear all caches (all models, HTML, MinerU, etc.)">
                        ${this.clearing==="all"?"Clearing...":"Clear All"}
                    </button>
                    ${this.pendingConfirm==="clearAll"?`
                        <div class="confirm-popup" role="dialog" aria-labelledby="confirm-all-title">
                            <div class="confirm-content">
                                <strong id="confirm-all-title">Clear ALL caches for this paper?</strong>
                                <p>This will remove:</p>
                                <ul>
                                    <li>All model summaries</li>
                                    <li>HTML/Markdown cache</li>
                                    <li>MinerU cache</li>
                                    <li>All related files</li>
                                </ul>
                                <p class="confirm-warning">This action cannot be undone!</p>
                                ${g}
                                <div class="confirm-actions">
                                    <button onclick="summaryApp.confirmClearAll()" class="confirm-btn confirm-yes">\u786E\u5B9A</button>
                                    <button onclick="summaryApp.cancelConfirm()" class="confirm-btn confirm-no">\u53D6\u6D88</button>
                                </div>
                            </div>
                        </div>
                    `:""}
                </div>
                ${o}
                ${h}
            </div>
        `}renderMetaLine(){const e=this.meta?this.formatTimestamp(this.meta.generated_at):"";return`
            <div class="summary-meta">
                <span class="summary-badge">AI</span>
                <span class="summary-note">${[e?`Generated at ${l(e)}`:""].filter(Boolean).join(" \xB7 ")||"This summary is automatically generated by AI"}</span>
            </div>
        `}getHTML(){const e=this.paper?String(this.paper.id||""):"",t=this.paper?l(this.paper.title):"",a=this.paper?String(this.paper.authors||""):"",n=M(a,{maxAuthors:10,head:5,tail:3}),s=l(n),o=l(a),h=this.paper?l(this.paper.time):"",u=this.paper&&this.paper.tags?l(this.paper.tags):"",f=this.paper?l(this.paper.summary||"No abstract available."):"",g=typeof user!="undefined"&&user,d=this.paper?`
            <div class="paper-header">
                <div class="paper-nav paper-actions-footer">
                    <div class="rel_more"><a href="/?rank=pid&pid=${encodeURIComponent(e)}" target="_blank" rel="noopener noreferrer">Similar</a></div>
                    <div class="rel_inspect"><a href="/inspect?pid=${encodeURIComponent(e)}" target="_blank" rel="noopener noreferrer">Inspect</a></div>
                    <div class="rel_alphaxiv"><a href="https://www.alphaxiv.org/overview/${encodeURIComponent(e)}" target="_blank" rel="noopener noreferrer">alphaXiv</a></div>
                    <div class="rel_cool"><a href="https://papers.cool/arxiv/${encodeURIComponent(e)}" target="_blank" rel="noopener noreferrer">Cool</a></div>
                </div>
                <div class="paper-content-section">
                    <div class="paper-main">
                        <h1 class="paper-title">
                            <a href="https://arxiv.org/abs/${encodeURIComponent(e)}" target="_blank" rel="noopener noreferrer">
                                ${t}
                            </a>
                        </h1>
                        <div class="paper-authors-line">
                            <span title="${o}">${s}</span>
                        </div>
                        <div class="paper-meta-line">
                            <span class="paper-time">${h}</span>
                            ${u?`<span class="paper-tags">${u}</span>`:""}
                        </div>
                        <div class="paper-abstract">
                            ${f}
                        </div>
                        ${g?`
                        <div class="paper-user-tags-section">
                            <div class="rel_utags" id="summary-tag-dropdown"></div>
                        </div>
                        `:""}
                    </div>
                </div>
            </div>
        `:"";let m="";if(this.loading)m=`
                <div class="summary-container" aria-busy="true">
                    <div class="summary-header">
                        <h2>Summary</h2>
                        ${this.renderMetaLine()}
                    </div>
                    ${this.renderActions()}
                    <div class="summary-content" aria-live="polite">
                        <div class="loading-indicator">
                            <div class="spinner"></div>
                            <p>Generating paper summary, please wait...</p>
                            <p class="loading-note">This may take a few moments</p>
                        </div>
                    </div>
                </div>
            `;else if(this.error){const p=l(this.error);m=`
                <div class="summary-container" aria-busy="false">
                    <div class="summary-header">
                        <h2>Summary</h2>
                        ${this.renderMetaLine()}
                    </div>
                    <div class="summary-content" aria-live="polite">
                        <div class="error-message" role="alert">
                            <p>\u26A0\uFE0F Error generating summary: ${p}</p>
                            ${this.renderActions()}
                        </div>
                    </div>
                </div>
            `}else this.content?m=`
                <div class="summary-container" aria-busy="false">
                    <div class="summary-header">
                        <h2>Summary</h2>
                        ${this.renderMetaLine()}
                    </div>
                    ${this.renderActions()}
                    <div class="summary-content" aria-live="polite">
                        <nav class="summary-toc" aria-label="Table of contents"></nav>
                        <div class="summary-markdown markdown-content"></div>
                    </div>
                </div>
            `:m=`
                <div class="summary-container" aria-busy="false">
                    <div class="summary-header">
                        <h2>Summary</h2>
                        ${this.renderMetaLine()}
                    </div>
                    <div class="summary-content" aria-live="polite">
                        <p>No summary available for this paper at the moment.</p>
                        ${this.renderActions()}
                    </div>
                </div>
            `;return d+m}}const i=new C;async function A(r,e={}){try{const t=new AbortController,a=setTimeout(()=>t.abort(),6e5),n=await fetch("/api/get_paper_summary",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":y()},body:JSON.stringify({pid:r,model:e.model||void 0,force_regenerate:!!e.force_regenerate,cache_only:!!e.cache_only}),signal:t.signal});clearTimeout(a);const s=await n.json().catch(()=>null);if(n.ok&&s&&s.success)return{content:s.summary_content,meta:s.summary_meta||{}};const o=new Error(s&&s.error||`HTTP ${n.status}: ${n.statusText}`);throw s&&s.code&&(o.code=s.code),o}catch(t){if(t.name==="AbortError"){const a=new Error("\u8ACB\u6C42\u8D85\u6642\uFF0C\u8AD6\u6587\u7E3D\u7D50\u904E\u7A0B\u8F03\u9577\uFF0C\u8ACB\u7A0D\u5F8C\u91CD\u8A66");throw a.code="summary_timeout",a}throw console.error("Failed to fetch summary:",t),t}}async function $(r,e){const t=await fetch("/api/clear_model_summary",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":y()},body:JSON.stringify({pid:r,model:e})});if(!t.ok)throw new Error(`HTTP ${t.status}: ${t.statusText}`);const a=await t.json();if(!a.success)throw new Error(a.error||"Failed to clear model summary");return a}async function _(r){const e=await fetch("/api/clear_paper_cache",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":y()},body:JSON.stringify({pid:r})});if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=await e.json();if(!t.success)throw new Error(t.error||"Failed to clear cache");return t}async function k(){const r=await fetch("/api/llm_models");if(!r.ok)throw new Error(`HTTP ${r.status}: ${r.statusText}`);const e=await r.json(),t=Array.isArray(e.models)?e.models:[];if(!e.success&&t.length===0)throw new Error(e.error||"Failed to load models");return t}async function E(r){const e=await fetch(`/api/check_paper_summaries?pid=${encodeURIComponent(r)}`);if(!e.ok)throw new Error(`HTTP ${e.status}: ${e.statusText}`);const t=await e.json();if(!t.success)throw new Error(t.error||"Failed to check available summaries");return Array.isArray(t.available_models)?t.available_models:[]}function S(r){const e=String(r||"").trim();return e?e.replace(/[^a-zA-Z0-9._-]+/g,"_"):""}i.retry=function(){this.pid&&this.loadSummary(this.pid,{force_regenerate:!0})};i.handleModelChange=function(r){const e=r&&r.target?r.target.value:"";this.setState({selectedModel:e}),this.pid&&this.loadSummary(this.pid,{model:e,cache_only:!0})};i.regenerate=function(){!this.pid||this.loading||this.isCurrentModelGenerating()||this.loadSummary(this.pid,{force_regenerate:!0,model:this.getCurrentModel()})};i.requestClearModel=function(){if(!this.pid||this.clearing)return;if(!this.getCurrentModel()){this.setState({error:"No model selected"});return}this.setState({pendingConfirm:"clearModel"})};i.confirmClearModel=async function(){const r=this.getCurrentModel();this.clearAutoRetry(),this.setState({clearing:"model",notice:"",error:null,pendingConfirm:null});try{await $(this.pid,r),this.setState({clearing:!1,content:null,meta:null,notice:`Summary for model "${r}" cleared. Click Generate to create a new one.`})}catch(e){const t=c.handleApiError(e,"Clear Model Summary");this.setState({clearing:!1,error:t})}};i.requestClearAll=function(){!this.pid||this.clearing||this.setState({pendingConfirm:"clearAll"})};i.confirmClearAll=async function(){this.clearAutoRetry(),this.setState({clearing:"all",notice:"",error:null,pendingConfirm:null});try{await _(this.pid),this.setState({clearing:!1,content:null,meta:null,notice:"All caches cleared. Click Generate to fetch a fresh summary."})}catch(r){const e=c.handleApiError(r,"Clear All Caches");this.setState({clearing:!1,error:e})}};i.cancelConfirm=function(){this.setState({pendingConfirm:null})};i.clearCache=i.confirmClearAll;i.loadSummary=async function(r,e={}){return await c.measurePerformanceAsync(`loadSummary(${r}, model=${e.model||"default"})`,async()=>{const t=this.requestSeq=(this.requestSeq||0)+1,a=e.model||this.getCurrentModel(),n=!!e.force_regenerate,s=!!e.cache_only;this.clearAutoRetry();const o=String(a||"").trim();n&&o&&(this.inflightModels[o]=!0);const h=String(this.contentModel||"").trim(),u=o&&o!==h,f=!!(o&&this.inflightModels[o]),g=n||!s&&!this.content||s&&f;this.setState({loading:g,error:null,regenerating:n,selectedModel:a||"",notice:s?"":this.notice,content:u?null:this.content,meta:u?null:this.meta});try{const d=await A(r,{model:a,force_regenerate:n,cache_only:s});if(t!==this.requestSeq)return;const m=d.meta||{},p=d.content;if(typeof p=="string"&&p.startsWith("# Error")&&p.includes("Summary is being generated")){this.pendingGenerationModel=a||"",this.setState({loading:!0,regenerating:!1,notice:"Summary is being generated for this model. You can switch models; this view will auto-refresh when ready.",error:null,content:null,meta:null}),this.scheduleAutoRetry(r,{model:a});return}const v=this.selectedModel||a||"";this.autoRetryCount=0,this.pendingGenerationModel="",o&&(this.inflightModels[o]=!1),this.setState({loading:!1,regenerating:!1,content:p,meta:m,contentModel:String(v||"").trim(),selectedModel:v,notice:""})}catch(d){if(t!==this.requestSeq)return;if(d.code==="summary_cache_miss"&&s){if(!!(o&&this.inflightModels[o])){this.pendingGenerationModel=o,this.setState({loading:!0,regenerating:!1,notice:"Summary is being generated for this model. You can switch models; this view will auto-refresh when ready.",error:null,content:null,meta:null}),this.scheduleAutoRetry(r,{model:o});return}this.setState({loading:!1,regenerating:!1,notice:"No cached summary for this model. Click Generate to create one.",error:null,content:null,meta:null,contentModel:String(o||"").trim()});return}const m=c.handleApiError(d,"Load Summary");this.setState({loading:!1,regenerating:!1,error:m}),(d.code==="summary_timeout"||String(d.message||"").includes("Failed to fetch"))&&this.scheduleAutoRetry(r,{model:a}),n&&o&&(this.inflightModels[o]=!1)}})};i.loadModels=async function(){return await c.measurePerformanceAsync("loadModels",async()=>{try{const r=await k();this.setState({models:r,modelsError:null})}catch(r){const e=c.handleApiError(r,"Load Models");this.setState({modelsError:e})}})};i.selectInitialModel=async function(r){try{const e=await E(r);let t="";const a=String(this.defaultModel||"").trim();if(a&&e.length>0){const n=S(a);n&&e.includes(n)&&(t=a)}if(!t&&e.length>0&&this.models.length>0)for(const n of this.models){const s=String(n.id||""),o=S(s);if(o&&e.includes(o)){t=s;break}}if(!t){if(a){const n=this.models.find(s=>String(s.id||"")===a);t=n&&n.id||""}!t&&this.models.length>0&&(t=this.models[0].id||"")}return this.setState({selectedModel:t}),t}catch(e){console.error("Failed to check available summaries:",e);let t="";const a=String(this.defaultModel||"").trim();if(a){const n=this.models.find(s=>String(s.id||"")===a);t=n&&n.id||""}return!t&&this.models.length>0&&(t=this.models[0].id||""),this.setState({selectedModel:t}),t}};async function L(){if(console.log("Initializing summary page..."),typeof paper=="undefined"){console.error("Paper data is missing!"),document.getElementById("wrap").innerHTML='<div style="padding: 20px; color: red;">Error: Paper data is missing</div>';return}if(typeof pid=="undefined"){console.error("Paper ID is missing!"),document.getElementById("wrap").innerHTML='<div style="padding: 20px; color: red;">Error: Paper ID is missing</div>';return}i.setState({paper,pid,loading:!0,meta:null,models:[],modelsError:null,selectedModel:"",notice:"",clearing:!1,defaultModel:typeof defaultSummaryModel!="undefined"?defaultSummaryModel:"",userTags:paper.utags||[],negativeTags:paper.ntags||[],availableTags:[],tagDropdownOpen:!1,tagSearchValue:"",newTagValue:""}),await i.loadModels();const r=await i.selectInitialModel(pid);i.loadSummary(pid,{model:r}),typeof user!="undefined"&&user&&(await x(),setupUserEventStream())}function R(){const r=document.getElementById("summary-tag-dropdown");if(!r||!window.ArxivSanityTagDropdown||typeof window.ArxivSanityTagDropdown.mount!="function")return;const e=i.paper&&i.paper.id?String(i.paper.id):"";if(!e)return;const t=sharedTagDropdownApi&&sharedTagDropdownApi.getUiState?sharedTagDropdownApi.getUiState():{};sharedTagDropdownApi&&sharedTagDropdownApi.unmount&&(sharedTagDropdownApi.unmount(),sharedTagDropdownApi=null),sharedTagDropdownApi=window.ArxivSanityTagDropdown.mount(r,{pid:e,selectedTags:i.userTags||[],negativeTags:i.negativeTags||[],availableTags:i.availableTags||[],open:i.tagDropdownOpen||t.open,searchValue:i.tagSearchValue||t.searchValue,newTagValue:i.newTagValue||t.newTagValue,onStateChange:a=>{i.userTags=a.selectedTags||[],i.negativeTags=a.negativeTags||[],i.availableTags=a.availableTags||[],i.tagDropdownOpen=!!a.open,i.tagSearchValue=a.searchValue||"",i.newTagValue=a.newTagValue||""}})}let w=!1;async function x(){typeof tags!="undefined"&&Array.isArray(tags)&&(i.availableTags=tags.filter(r=>r&&r.name&&r.name!=="all").map(r=>r.name).sort()),!w&&(w=!0,document.addEventListener("keydown",r=>{r.key==="Escape"&&i.pendingConfirm&&i.cancelConfirm()}),document.addEventListener("mousedown",r=>{if(i.pendingConfirm){const e=document.querySelector(".confirm-popup");if(e&&!e.contains(r.target)){const t=e.closest(".summary-btn-group"),a=t?t.querySelector(".summary-action-btn"):null;(!a||!a.contains(r.target))&&i.cancelConfirm()}}}))}document.addEventListener("DOMContentLoaded",L);})();
